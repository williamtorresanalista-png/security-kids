<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Security Kids - Emerg√™ncia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; color: #1e293b; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .avatar { width: 75px; height: 75px; background: #0f172a; color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 35px; font-weight: 800; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-info { border-radius: 15px; border: 1px solid #e2e8f0 !important; margin-bottom: 8px; background: #fff; }
        .label-custom { font-size: 0.8rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0px; }
        .value-custom { font-size: 1.25rem; font-weight: 700; color: #0f172a; line-height: 1.2; }
        .btn-whatsapp { background-color: #22c55e; color: white; border-radius: 12px; font-size: 1.1rem; padding: 14px; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2); }
        .actions-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); padding: 12px 18px 25px 18px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 15px rgba(0,0,0,0.04); }
        .alert-warning-custom { background-color: #fefce8; border-left: 4px solid #eab308; border-radius: 10px; padding: 12px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loading" class="loading-screen">
    <div class="spinner-border text-primary spinner-border-sm mb-2"></div>
    <span class="small fw-bold text-muted">Acessando Dados...</span>
</div>

<div id="app" style="display:none; padding-bottom: 160px;"></div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxpcXWSLYw4Mtxq59FPY-jaFPYvWEjVk595cUwiKfsuxJl5M3wdr_JhXXRyC0swEZz2Eg/exec";

    async function carregarDados() {
        const urlParams = new URLSearchParams(window.location.search);
        const codigo = urlParams.get('codigo');
        if (!codigo) { mostrarErro("ACESSO INV√ÅLIDO", "C√≥digo n√£o detectado."); return; }
        try {
            const response = await fetch(`${API_URL}?codigo=${codigo}`, { method: 'GET', cache: 'no-store', redirect: 'follow' });
            const data = await response.json();
            if (data.error) { mostrarErro("ERRO", "Pulseira n√£o localizada."); return; }
            renderizarApp(data);
        } catch (e) { mostrarErro("CONEX√ÉO", "Falha ao carregar."); }
    }

    function renderizarApp(data) {
        const app = document.getElementById('app');
        
        // --- MAPEAMENTO EXATO DOS SEUS CAMPOS ---
        const nome = data["Nome da crian√ßa"] || "Crian√ßa";
        const idadeVal = data["Idade"] ? data["Idade"] + " anos" : "";
        const sexoVal = data["Sexo"] || "";
        const obs = data["Observa√ß√µes da crian√ßa"] || "";
        
        // Buscando o telefone principal (Respons√°vel 1)
        let telRaw = String(data["WhatsApp ou Telefone Responsavel 1"] || "").replace(/\D/g, "");
        if (telRaw.length > 0 && !telRaw.startsWith('55')) {
            telRaw = '55' + telRaw;
        }

        let infoHtml = "";
        // Lista de campos que N√ÉO devem aparecer nos cart√µes de detalhes (porque j√° est√£o no topo ou s√£o internos)
        const ocultar = [
            "Nome da crian√ßa", "Observa√ß√µes da crian√ßa", "Idade", "Sexo", 
            "C√≥digo da Pulseira", "Submission ID", "Respondent ID", "Submitted at"
        ];
        
        for (let key in data) {
            // Se o campo tem valor e n√£o est√° na lista de ocultar
            if (data[key] && !ocultar.includes(key)) {
                infoHtml += `
                    <div class="card card-info">
                        <div class="card-body p-2 px-3">
                            <div class="label-custom">${key}</div>
                            <div class="value-custom">${data[key]}</div>
                        </div>
                    </div>`;
            }
        }

        app.innerHTML = `
            <div class="text-center py-3 bg-white mb-3 shadow-sm">
                <div class="avatar">${nome.charAt(0)}</div>
                <h3 class="fw-bold mt-2 mb-0" style="font-size: 1.7rem;">${nome}</h3>
                <div class="d-flex justify-content-center gap-2 mt-1">
                    ${idadeVal ? `<span class="badge bg-dark" style="font-size: 0.85rem; border-radius: 20px;">${idadeVal}</span>` : ''}
                    ${sexoVal ? `<span class="badge bg-secondary" style="font-size: 0.85rem; border-radius: 20px;">${sexoVal}</span>` : ''}
                </div>
                <p class="text-muted extra-small text-uppercase fw-bold m-0 mt-2" style="font-size: 0.65rem; letter-spacing: 1px;">Security Kids - Ativa</p>
            </div>
            
            <div class="container px-3">
                ${obs ? `
                    <div class="alert-warning-custom">
                        <small class="fw-bold text-uppercase d-block mb-1" style="font-size: 0.75rem;">‚ö†Ô∏è Cuidados Especiais</small>
                        <div class="fw-bold" style="font-size: 1.1rem; line-height: 1.3;">${obs}</div>
                    </div>` : ''}
                ${infoHtml}
            </div>

            <div class="actions-footer">
                <button class="btn btn-whatsapp w-100 mb-2" onclick="enviarLocalizacao('${telRaw}', '${nome}')">
                    <i class="bi bi-whatsapp"></i> AVISAR RESPONS√ÅVEL
                </button>
                <div class="row g-2">
                    <div class="col-6"><a href="tel:190" class="btn btn-outline-danger btn-sm w-100 py-2 fw-bold" style="font-size: 0.85rem;">POL√çCIA 190</a></div>
                    <div class="col-6"><a href="https://tally.so/r/pbd5zy" class="btn btn-outline-secondary btn-sm w-100 py-2 fw-bold" style="font-size: 0.85rem;">EDITAR</a></div>
                </div>
            </div>
        `;
        document.getElementById('loading').style.display = 'none';
        app.style.display = 'block';
    }

    function enviarLocalizacao(tel, nome) {
        if (!tel || tel.length < 10) { 
            alert("Erro: N√∫mero do Respons√°vel 1 n√£o encontrado ou incompleto na planilha."); 
            return; 
        }

        const btn = document.querySelector('.btn-whatsapp');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> LOCALIZANDO...';
        
        const msg = `Achei seu filho(a) ${nome} atrav√©s da Pulseira Security Kids. Segue minha localiza√ß√£o:`;
        const linkWa = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                // CORRE√á√ÉO DEFINITIVA DO S√çMBOLO $ PARA O GPS
                const mapa = `\n\nüìç Mapa: https://www.google.com/maps?q=${lat},${lon}`;
                window.location.href = linkWa + encodeURIComponent(mapa);
            }, () => { 
                window.location.href = linkWa; 
            }, { timeout: 6000 });
        } else { 
            window.location.href = linkWa; 
        }
    }

    function mostrarErro(titulo, subtitulo) {
        document.getElementById('loading').innerHTML = `<div class="text-center p-4 small"><h6 class="text-danger fw-bold">${titulo}</h6><p>${subtitulo}</p></div>`;
    }

    carregarDados();
</script>
</body>
</html>